{% extends 'base.html' %}

{% block title %}Security - Book Hive{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    
    <div class="mb-3">
        <a href="{{ url_for('user_profile') }}" class="btn back-btn">
            <i class="fas fa-arrow-left me-2"></i>Back to My Profile
        </a>
    </div>
    
    
    <div class="security-header">
        <div class="text-center">
            <h1 class="display-5 fw-bold mb-2">Security Settings</h1>
            <p class="lead">Manage your password and account security</p>
        </div>
    </div>

    
    <div class="security-section">
        <h3 class="section-title">
            <i class="fas fa-lock me-2"></i>Change Password
        </h3>
        
        <div class="alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Choose a strong password that you don't use for other websites
        </div>
        
        <form method="POST" id="passwordForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="current_password" class="form-label">Current Password *</label>
                    <input type="password" class="form-control" id="current_password" 
                           name="current_password" required>
                    <div class="help-text">Enter your current password to verify your identity</div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="new_password" class="form-label">New Password *</label>
                    <input type="password" class="form-control" id="new_password" 
                           name="new_password" required minlength="6">
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-text" id="strengthText">Enter a password</div>
                    </div>
                    <div class="help-text">Minimum 6 characters. Use a mix of letters, numbers, and symbols</div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="confirm_password" class="form-label">Confirm New Password *</label>
                    <input type="password" class="form-control" id="confirm_password" 
                           name="confirm_password" required>
                    <div class="help-text">Re-enter your new password to confirm</div>
                </div>
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-primary-custom btn-lg me-3">
                    <i class="fas fa-lock me-2"></i>Change Password
                </button>
                <button type="button" class="btn btn-secondary-custom btn-lg" onclick="clearPasswordForm()">
                    <i class="fas fa-times me-2"></i>Clear
                </button>
            </div>
        </form>
    </div>

    
    <div class="security-section">
        <h3 class="section-title">
            <i class="fas fa-history me-2"></i>Recent Login Activity
        </h3>
        
        <div class="alert-info">
            <i class="fas fa-info-circle me-2"></i>
            This shows your recent login attempts and the locations/devices used
        </div>
        
        {% if login_history %}
            {% for login in login_history %}
                <div class="login-history-item">
                    <div class="login-info">
                        <div class="login-time">
                            {{ login.login_time.strftime('%B %d, %Y at %I:%M %p') }}
                        </div>
                        <div class="login-details">
                            {% if login.ip_address %}
                                <i class="fas fa-map-marker-alt me-1"></i>{{ login.ip_address }}
                            {% endif %}
                            {% if login.user_agent %}
                                <span class="ms-3">
                                    {% if 'Chrome' in login.user_agent %}
                                        <i class="fab fa-chrome"></i> Chrome
                                    {% elif 'Firefox' in login.user_agent %}
                                        <i class="fab fa-firefox"></i> Firefox
                                    {% elif 'Safari' in login.user_agent %}
                                        <i class="fab fa-safari"></i> Safari
                                    {% elif 'Edge' in login.user_agent %}
                                        <i class="fab fa-edge"></i> Edge
                                    {% else %}
                                        <i class="fas fa-globe"></i> Browser
                                    {% endif %}
                                </span>
                            {% endif %}
                            {% if login.session_duration %}
                                <span class="ms-3">
                                    <i class="fas fa-clock me-1"></i>{{ login.session_duration }} min
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="login-status {{ 'status-success' if login.login_status == 'success' else 'status-failed' }}">
                        {{ login.login_status }}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No login history available</h4>
                <p class="text-muted">Your recent login activity will appear here</p>
            </div>
        {% endif %}
    </div>

    
    <div class="security-section">
        <h3 class="section-title">
            <i class="fas fa-shield-alt me-2"></i>Security Tips
        </h3>
        
        <div class="security-tip">
            <div class="security-tip-title">
                <i class="fas fa-check-circle"></i>
                Use a Strong Password
            </div>
            <p class="mb-0">Include uppercase letters, lowercase letters, numbers, and special characters. Avoid using common words or personal information.</p>
        </div>
        
        <div class="security-tip">
            <div class="security-tip-title">
                <i class="fas fa-check-circle"></i>
                Enable Two-Factor Authentication
            </div>
            <p class="mb-0">Add an extra layer of security by enabling 2FA on your account (coming soon).</p>
        </div>
        
        <div class="security-tip">
            <div class="security-tip-title">
                <i class="fas fa-check-circle"></i>
                Monitor Login Activity
            </div>
            <p class="mb-0">Regularly check your login history for any suspicious activity. Contact support if you see anything unusual.</p>
        </div>
        
        <div class="security-tip">
            <div class="security-tip-title">
                <i class="fas fa-check-circle"></i>
                Keep Your Email Secure
            </div>
            <p class="mb-0">Your email is often used for password recovery. Make sure it's protected with a strong password.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Password strength checker
function checkPasswordStrength(password) {
    let strength = 0;
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    if (password.length >= 6) strength++;
    if (password.length >= 10) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z\d]/.test(password)) strength++;
    
    // Remove all strength classes
    strengthFill.className = 'strength-fill';
    
    if (password.length === 0) {
        strengthFill.style.width = '0';
        strengthText.textContent = 'Enter a password';
        strengthText.style.color = 'var(--text-secondary)';
    } else if (strength <= 2) {
        strengthFill.classList.add('strength-weak');
        strengthText.textContent = 'Weak password';
        strengthText.style.color = '#ef4444';
    } else if (strength <= 3) {
        strengthFill.classList.add('strength-fair');
        strengthText.textContent = 'Fair password';
        strengthText.style.color = '#f59e0b';
    } else if (strength <= 4) {
        strengthFill.classList.add('strength-good');
        strengthText.textContent = 'Good password';
        strengthText.style.color = '#3b82f6';
    } else {
        strengthFill.classList.add('strength-strong');
        strengthText.textContent = 'Strong password';
        strengthText.style.color = '#10b981';
    }
}

document.getElementById('new_password').addEventListener('input', function() {
    checkPasswordStrength(this.value);
});

// Form validation
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        e.preventDefault();
        alert('All password fields are required');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('New passwords do not match');
        return;
    }
    
    if (newPassword.length < 6) {
        e.preventDefault();
        alert('Password must be at least 6 characters long');
        return;
    }
    
    if (currentPassword === newPassword) {
        e.preventDefault();
        alert('New password must be different from current password');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Changing...';
    submitBtn.disabled = true;
});

function clearPasswordForm() {
    document.getElementById('passwordForm').reset();
    document.getElementById('strengthFill').style.width = '0';
    document.getElementById('strengthText').textContent = 'Enter a password';
    document.getElementById('strengthText').style.color = 'var(--text-secondary)';
}

// Show/hide password functionality (optional enhancement)
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = event.target;
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}
</script>
{% endblock %}
