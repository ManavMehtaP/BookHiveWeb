{% extends 'base.html' %}

{% block title %}Manage Bookings - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-ticket-alt me-2"></i>
            Manage Bookings
        </h2>
        <div class="d-flex gap-2">
            <select class="form-select" id="statusFilter" style="width: auto;">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="cancelled">Cancelled</option>
            </select>
            <select class="form-select" id="paymentFilter" style="width: auto;">
                <option value="">All Payment</option>
                <option value="paid">Paid</option>
                <option value="refunded">Refunded</option>
            </select>
        </div>
    </div>
    
    {% if bookings %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Reference</th>
                        <th>Event</th>
                        <th>Customer</th>
                        <th>User</th>
                        <th>Seats</th>
                        <th>Total Price</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                        <tr data-status="{{ booking.booking_status }}" data-payment="{{ booking.payment_status or 'paid' }}">
                            <td>{{ booking.id }}</td>
                            <td>
                                {% if booking.booking_reference %}
                                    <code>{{ booking.booking_reference }}</code>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>
                                    <strong>{{ booking.title }}</strong>
                                    <br>
                                    <small class="text-muted">{{ booking.event_date }} {{ booking.event_time[:5] }}</small>
                                    <br>
                                    <small class="text-muted">{{ booking.location }}</small>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ booking.customer_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ booking.customer_email }}</small>
                                    <br>
                                    <small class="text-muted">{{ booking.phone }}</small>
                                </div>
                            </td>
                            <td>
                                {% if booking.username %}
                                    <div>
                                        <strong>{{ booking.username }}</strong>
                                        <br>
                                        <small class="text-muted">{{ booking.user_full_name or '' }}</small>
                                    </div>
                                {% else %}
                                    <span class="badge bg-secondary">Guest</span>
                                {% endif %}
                            </td>
                            <td>{{ booking.seats_booked }}</td>
                            <td>${{ "%.2f"|format(booking.total_price) }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if booking.booking_status == 'active' else 'danger' }}">
                                    {{ booking.booking_status.title() }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if booking.payment_status == 'paid' else 'info' }}">
                                    {{ (booking.payment_status or 'paid').title() }}
                                </span>
                            </td>
                            <td>{{ booking.booking_date[:10] }}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary view-booking" 
                                            data-booking-id="{{ booking.id }}"
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary edit-booking" 
                                            data-booking-id="{{ booking.id }}"
                                            data-current-status="{{ booking.booking_status }}"
                                            data-current-payment="{{ booking.payment_status or 'paid' }}"
                                            title="Edit Status">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No bookings found</h4>
            <p class="text-muted">No bookings have been made yet.</p>
        </div>
    {% endif %}
</div>


<div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookingDetailsContent">
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Booking Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editBookingForm">
                    <div class="mb-3">
                        <label for="bookingStatus" class="form-label">Booking Status</label>
                        <select class="form-select" id="bookingStatus" required>
                            <option value="active">Active</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentStatus" class="form-label">Payment Status</label>
                        <select class="form-select" id="paymentStatus" required>
                            <option value="paid">Paid</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBookingChanges">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookingDetailsModal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
    const editBookingModal = new bootstrap.Modal(document.getElementById('editBookingModal'));
    let currentBookingId = null;
    
    // View booking details
    document.querySelectorAll('.view-booking').forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.dataset.bookingId;
            fetch(`/api/admin/booking-details/${bookingId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayBookingDetails(data.booking);
                        bookingDetailsModal.show();
                    } else {
                        alert(data.message || 'Error loading booking details');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading booking details');
                });
        });
    });
    
    // Edit booking
    document.querySelectorAll('.edit-booking').forEach(button => {
        button.addEventListener('click', function() {
            currentBookingId = this.dataset.bookingId;
            document.getElementById('bookingStatus').value = this.dataset.currentStatus;
            document.getElementById('paymentStatus').value = this.dataset.currentPayment;
            editBookingModal.show();
        });
    });
    
    // Save booking changes
    document.getElementById('saveBookingChanges').addEventListener('click', function() {
        const status = document.getElementById('bookingStatus').value;
        const paymentStatus = document.getElementById('paymentStatus').value;
        
        fetch(`/api/admin/update-booking-status/${currentBookingId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: status,
                payment_status: paymentStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Error updating booking');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating booking');
        });
    });
    
    // Filter functionality
    document.getElementById('statusFilter').addEventListener('change', filterBookings);
    document.getElementById('paymentFilter').addEventListener('change', filterBookings);
    
    function filterBookings() {
        const statusFilter = document.getElementById('statusFilter').value;
        const paymentFilter = document.getElementById('paymentFilter').value;
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const status = row.dataset.status;
            const payment = row.dataset.payment;
            
            const statusMatch = !statusFilter || status === statusFilter;
            const paymentMatch = !paymentFilter || payment === paymentFilter;
            
            row.style.display = statusMatch && paymentMatch ? '' : 'none';
        });
    }
    
    function displayBookingDetails(booking) {
        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Event Information</h6>
                    <p><strong>Title:</strong> ${booking.title}</p>
                    <p><strong>Genre:</strong> ${booking.genre}</p>
                    <p><strong>Date:</strong> ${booking.event_date}</p>
                    <p><strong>Time:</strong> ${booking.event_time}</p>
                    <p><strong>Location:</strong> ${booking.location}</p>
                    ${booking.venue ? `<p><strong>Venue:</strong> ${booking.venue}</p>` : ''}
                    <p><strong>Price per seat:</strong> $${parseFloat(booking.event_price).toFixed(2)}</p>
                </div>
                <div class="col-md-6">
                    <h6>Customer Information</h6>
                    <p><strong>Name:</strong> ${booking.customer_name}</p>
                    <p><strong>Email:</strong> ${booking.customer_email}</p>
                    <p><strong>Phone:</strong> ${booking.phone}</p>
                    ${booking.username ? `
                        <h6 class="mt-3">User Account</h6>
                        <p><strong>Username:</strong> ${booking.username}</p>
                        <p><strong>Full Name:</strong> ${booking.full_name}</p>
                        <p><strong>Email:</strong> ${booking.email}</p>
                    ` : '<p class="text-muted">Guest booking (no user account)</p>'}
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>Booking Details</h6>
                    <p><strong>Booking ID:</strong> ${booking.id}</p>
                    <p><strong>Reference:</strong> ${booking.booking_reference || 'N/A'}</p>
                    <p><strong>Seats Booked:</strong> ${booking.seats_booked}</p>
                    <p><strong>Total Price:</strong> $${parseFloat(booking.total_price).toFixed(2)}</p>
                    <p><strong>Booking Date:</strong> ${booking.booking_date}</p>
                    ${booking.notes ? `<p><strong>Notes:</strong> ${booking.notes}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Status Information</h6>
                    <p><strong>Booking Status:</strong> <span class="badge bg-${booking.booking_status === 'active' ? 'success' : 'danger'}">${booking.booking_status}</span></p>
                    <p><strong>Payment Status:</strong> <span class="badge bg-${booking.payment_status === 'paid' ? 'success' : 'info'}">${booking.payment_status}</span></p>
                    <p><strong>Available Seats:</strong> ${booking.available_seats}</p>
                    <p><strong>Total Seats:</strong> ${booking.total_seats}</p>
                </div>
            </div>
        `;
        
        document.getElementById('bookingDetailsContent').innerHTML = content;
    }
});
</script>

<style>
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table th {
    font-weight: 600;
    background-color: rgba(255, 255, 255, 0.1);
}

code {
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
}
</style>
{% endblock %}
